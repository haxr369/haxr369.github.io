---
title: '[ASAC 주간 스터디] AWS CloudFormation'
date: 2024-03-21
lastmod: 2024-03-21
tags: ['AWS', 'IAM', 'EC2', 'SG', 'CloudFormation', 'ASAC-Weekly-Study']
draft: false
summary: 'AWS CloudFormation으로 인프라 설정하기'
---

## 목차

<TOCInline toc={props.toc} exclude="목차" toHeading={(2, 3)} />

이번 포스팅은 **CloudFormation**의 문법을 알아보고 EC2와 Security Groups(SG)를 생성하는 방법을 실습하고자 한다.
시험에서는 CloudFormation의 정확한 사용법까지는 물어보지 않고 기능에 대한 간단한 질문만 한다.

## CloudFormation란?

Elastic Beanstalk으로 인프라 생성을 약간 자동화 했고, Code Deploy나 Code Pipeline 같은 서비스를 CICD를 자동화 했지만, 한번 생성한 인프라를 다른 Region으로 복제하기 어렵다.
**CloudFormation**은 AWS에서 제공하는 거이 모든 리소스를 코드로 관리할 수 있게한다.
여기서 코드는 **YAML**과 Json으로 작성한다.

1. 코드형 인프라를 이용해 수동으로 생성되는 리소스가 없어 관리하기 편하다.
2. Git 같은 버전 관리 툴을 이용해 CloudFormation의 버전을 관리할 수 있다.
3. 인프라의 모든 변경은 코드를 통해 검토된다.
4. 선언형 프로그래밍으로 리소스 생성 순서를 관리할 필요 없다. CloudFormation이 순서대로 알아서 생성한다.

비용을 아끼고 싶다면 오후 5시에 모든 템플릿을 제거하고 오전 8시에 안전하게 재생성할 수 있다.

### 관심사 분리

서브넷을 생성하는 `VPC stack`, 모든 네트워크를 생성하는 `Network stack`, 애플리케이션 리소스를 생성하는 `App stack`이 있다.
Elastic Beanstalk은 CloudFormation을 랩핑해서 리소스를 생성하는 것이다.

AWS 콘솔에서 CloudFormation 코드를 실행시키려고 **업로드**하면 백그라운드에서 S3에 저장되고 이를 CloudFormation에서 S3에대한 참조를 사용한다.
이전에 업로드한 템플릿을 수정하진 않고 새롭게 업로드한다. 왜냐하면 템플릿 업데이트가 실패했을 때 이전 버전의 템플릿으로 롤백시켜야하기 때문이다.

**배포하는 방법**

1. AWS CLI를 이용하기
2. AWS CloudFormation 콘솔 사용하기

## CloudFormation 예시

```YAML
AWSTemplateFormatVersion: 2010-09-09
Parameters: # 실행시 parameter를 입력하도록함
  SecurityGroupDescription:
    Description: EC2 can connect DynamoDB
    Type: String # Type을 지정해서 어떤 값을 입력해야하는지 제한할 수 있다.

Resources:
  MyEC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      AvailabilityZone: ap-northeast-2a
      ImageId: ami-081a36454cdf357cb
      InstanceType: t2.micro
      SecurityGroupIds: # 직접 SG id를 입력
        - !Ref ServerSecurityGroup # 이미 존재하는 SG에 접근하려는 경우
      Tags:
        - Key: team
          Value: lizohada

  # an elastic IP for our instance
  MyEIP:
    Type: AWS::EC2::EIP
    Properties:
      InstanceId: !Ref MyEC2Instance

  # our second EC2 security group to http
  ServerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      VpcId: vpc-01b038b9d6b0cdee4
      GroupDescription: !Ref SecurityGroupDescription # Parameters를 통해 SG의 설명을 작성
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0

```

## CloudFormation 블럭 이해하기

**CloudFormation 컴포넌트**

1. **Resources** : 템플릿으로 생성할 AWS 리소스 - **필수**
2. **Parameters** : 유저가 템플릿에 넣는 동적변수 - 선택
3. **Mapping** : 템플릿의 정적변수 - 선택
4. **Output** : 다른 템플릿에서 참조할 수 있도록 생성하는 것 - 선택
5. **Condition** : 리소스 생성을 조건에 따라 제어할 수 있다. 보통 환경(dev, test, prod)이나 Region 선택 같은 조건에 따라 파라미터를 다르게 적용시킨다.

**CloudFormation helpers**

1. References
2. Functions

## Resources

리소스의 의존 관계를 AWS가 자동으로 파악해서 어떤 리소스를 먼저 생성해야하는지 판단한다.
따라서 리소스는 서로 참조될 수 있다. (ex EC2와 Security Groups) 전부 224개의 리소스가 있다고 한다.
[AWS 리소스 및 속성 유영 참조](https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/aws-template-resource-type-ref.html)에 보면 리소스에 대한 설명이 있다.

중요한 점은 리소스에 대해 작성할 때 `Resources`블럭 및에 작성해야하고 `Type`과 `Properties`를 꼭 작성해야하는 것이다.

## Parameters

파라미터는 사용자가 CloudFormation template에 입력하는 동적변수다.
한 템플릿을 다른 계정이나 다른 회사가 사용할 때 적절히 입력해야하는 부분이다.

1. AWS::AccountId
2. AWS::NotificationARNs
3. AWS::NoValue
4. AWS::Region
5. AWS::StackId
6. AWS::StackName

### References 파라미터

`Ref`라는 함수를 이용해서 파라미터 변수를 리소스에서 사용할 수 있다.

```
 GroupDescription: !Ref SecurityGroupDescription
```

### mappings

```YAML
Mappings:
  Mapping01:
    Key1:
      Name: Value01
    Key2:
      Name: Value02
    Key3:
      Name: Value03
```

```YAML
RegionsMap:
  us-east-1:
    "32":"ami-43434-d"
    "64":"ami-84374-d"
  us-east-2:
    "32":"ami-43435-d"
    "64":"ami-84375-d"
  us-east-3:
    "32":"ami-43436-d"
    "64":"ami-84376-d"
```

mappings와 parameter 중 선택한다면? 약간 제약이 있지만 안전한 사용을 위해 mappings를 사용하게 좋다.

- Regions
- AvailabilityZone
- Environment (dev vs prod)

## Output

Output은 다른 스택에서 import할 수 있게 출력물을 정하는 부분이다.
예를 들어 VPC ID나 Subnet ID

```YAML
Outputs:
  StackSSHSecurityGroup:
    Export:
      Name: SSHSecurityGroup
```

### Cross Stack Reference

사전에 템플릿으로 생성한 리소스를 다른 템플릿에서 import하는 예시는 아래와 같다.

```YAML
Resources:
  MySecureInstance:
    Type: AWS::EC2::Instance
    Properties:
      ...
      SecurityGroup:
        - !ImportValue SSHSecurityGroup
```

## CloudFormation 함수

시험에 무조건 나오는 함수는 아래와 같다.

- **!Ref** : 매개변수를 참조할 때 사용. Parameters, Resources(EC2 ID 같은 리소스의 물리적 ID)
- **Fn::GetAtt** : Ref는 리소스의 ID만 얻지만, GetAtt를 사용하여 리소스의 **속성**(AZ, PublicIP, ...)을 얻는다.
- **Fn::FindInMap** : "ex) !FindInMap [RegionMap, !Ref "AWS:Region", 32]"
- **Fn::ImportValue** : 다른 CloudFormation 템플릿에서 출력한 인프라 id를 참조해서 사용
- **!Join** : delimiter와 구분자의 리스트를 넣으면 문자열을 만들어준다. ex) !Join [":", [a, b, b]] == "a:b:c"
- **!Sub** : substitute 문자열에서 어떤 부분을 대체할 때 사용한다.
- **Condition Functions** : (Fn::If, Not, Equals, ...) ex) `!Equals [!Ref EnvType, prod]`

## CloudFormation 롤백

스택을 생성하지 못하면 모두 삭제되고 롤백된다.
업데이트가 실패하면 이전에 성공한 스택으로 롤백하고
처음 생성할 때는 전부 다 지우거나 롤백을 하지 않도록해서 문제를 해결할 수 있도록 할 수 있다.

처음 스택을 생성할 때 실패했다면 조금 만들어진 리소스들을 수동으로 **삭제**하고 새로운 스택을 작성해서 생성해야한다.

## ChangeSets

stack을 업데이트할 때 before와 after를 쉽게 알 수 있다.
하지만 ChangeSets은 업데이트가 성공할 것은 알려주지 않는다.

## Cross, Nested Stacks 그리고 StackSets

1. Cross Stacks

스택이 다른 라이프 사이클을 가질 때 사용한다.
`ImportValue`를 이용해서 한 스택의 Output을 다른 스택이 사용할 때 유용하다
VPC ID 같이 다른 스택에게 export value를 제공할 때 사용한다.

2. Nested Stacks

한번 사용된 컴포넌트를 **재사용**할 때 사용한다. 2. nested stack은 동일 레벨의 스택 간 공유되지 않기 때문에 오직 더 높은 레벨의 스택에 영향을 끼친다.
예를 들어 Load Balancer나 Security Group 같이 자주 재사용되는 것들에 좋다.

Cross Stacks는 동일 레벨 다른 스택에게 export value를 제공하지만,
Nested Stacks는 동일 레벨에 공유되지 않고 더 높은 레벨,
즉 ELB, ASG, RDS 가 합쳐서 Application Stack을 이루고
이 App Stack을 재사용해서 새로운 인프라를 만들 수 있다.

3. StackSets

한 조직에서 **여러 계정과 리전**에 걸쳐서 스택을 생성,
업데이트 또는 삭제하는데 stack을 사용할 수 있게한다.

관리자 계정이 StackSets를 생성하면 신뢰하는 계정들이 스택 인스턴스를 StackSets로 CRUD할 수 있다.
만약 StackSets을 업데이트하면 모든 리전과 계정에 대한 스택 인스턴스 또한 업데이트된다.
